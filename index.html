<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boogle Browser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        window: 'var(--window-bg)',
                        toolbar: 'var(--toolbar-bg)',
                        primary: 'var(--text-primary)',
                        secondary: 'var(--text-secondary)',
                        inputBox: 'var(--input-bg)',
                        borderLight: 'var(--border-color)',
                        hover: 'var(--hover-bg)',
                        dropdown: 'var(--dropdown-bg)',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --default-window-bg: #dee1e6;
            --window-bg: var(--custom-color, var(--default-window-bg));
            --toolbar-bg: #ffffff;
            --tab-active-bg: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --input-bg: #f1f3f4;
            --border-color: #dfe1e5;
            --hover-bg: rgba(0,0,0,0.08);
            --dropdown-bg: #ffffff;
            
            --boogle-1: #4285F4;
            --boogle-2: #EA4335;
            --boogle-3: #FBBC05;
            --boogle-4: #4285F4;
            --boogle-5: #34A853;
            --boogle-6: #EA4335;
        }

        html.dark {
            --default-window-bg: #202124;
            --window-bg: var(--custom-color, var(--default-window-bg));
            --toolbar-bg: #323639;
            --tab-active-bg: #323639;
            --text-primary: #f1f3f4;
            --text-secondary: #9aa0a6;
            --input-bg: #202124;
            --border-color: #2b2e31;
            --hover-bg: rgba(255,255,255,0.15);
            --dropdown-bg: #2d3135;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
            background-color: var(--window-bg);
            color: var(--text-primary);
            transition: background-color 0.3s ease;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .tab-active {
            background-color: var(--tab-active-bg) !important;
            color: var(--text-primary) !important;
            z-index: 10;
        }

        .boogle-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 85px;
            font-weight: 600;
            letter-spacing: -3px;
            user-select: none;
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.05));
        }
        
        .boogle-logo-small {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 600;
            letter-spacing: -1px;
            user-select: none;
        }

        .loader-bar {
            height: 3px;
            background: linear-gradient(to right, var(--boogle-1), var(--boogle-2), var(--boogle-3), var(--boogle-4), var(--boogle-5), var(--boogle-6));
            position: absolute;
            top: 0;
            left: 0;
            transition: width 0.3s ease;
            z-index: 100;
            pointer-events: none;
        }

        #viewport iframe {
            border: none;
            width: 100%;
            height: 100%;
            display: block;
        }

        .material-input {
            position: relative;
            margin-bottom: 1.5rem;
        }
        .material-input input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
            background: transparent;
            color: var(--text-primary);
        }
        .material-input input:focus {
            border-color: var(--boogle-1);
            border-width: 2px;
            padding: 11px 15px;
        }
        .material-input label {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--dropdown-bg);
            padding: 0 4px;
            color: var(--text-secondary);
            font-size: 16px;
            transition: 0.2s ease all;
            pointer-events: none;
        }
        .material-input input:focus ~ label,
        .material-input input:not(:placeholder-shown) ~ label {
            top: 0;
            font-size: 12px;
            color: var(--boogle-1);
        }
    </style>
</head>
<body class="flex flex-col bg-window text-primary transition-colors duration-300">

    <!-- Tab Bar -->
    <div id="tab-bar-container" class="flex items-end px-2 pt-2 gap-0 select-none h-[40px] shrink-0 overflow-hidden">
        <div id="tab-list" class="flex items-end gap-0 overflow-x-auto no-scrollbar flex-1">
            <!-- Tabs injected here -->
        </div>
        <button id="add-tab" class="p-1.5 mb-1 ml-1 text-secondary hover:bg-hover rounded-full transition-colors shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
    </div>

    <!-- Toolbar -->
    <div class="bg-toolbar border-b border-borderLight px-2 md:px-3 py-1.5 flex items-center gap-2 md:gap-3 z-20 shrink-0 relative transition-colors duration-300">
        <div class="flex gap-1 text-secondary shrink-0">
            <button onclick="window.refreshActiveTab()" class="p-2 hover:bg-hover rounded-full transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
            </button>
        </div>
        
        <div class="flex-1 relative">
            <form id="address-form" onsubmit="window.handleAddressSubmit(event)" class="bg-inputBox rounded-full h-[32px] flex items-center px-4 border border-transparent focus-within:bg-toolbar focus-within:border-blue-400 focus-within:shadow-sm transition-all">
                <div class="flex items-center justify-center mr-3 text-secondary shrink-0 w-4 h-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <input id="address-input" class="flex-1 bg-transparent outline-none text-[13px] text-primary h-full min-w-0" placeholder="Search Boogle or type a URL" autocomplete="off" />
            </form>
        </div>

        <div class="flex items-center gap-1 shrink-0 ml-1">
            <button id="settings-trigger" onclick="window.toggleSettingsDropdown(event)" class="p-2 text-secondary hover:bg-hover hover:text-primary rounded-full transition-all flex items-center justify-center" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
            <div id="auth-ui" class="relative"></div>
        </div>
    </div>

    <!-- Main Viewport Area -->
    <div id="viewport-container" class="flex-1 overflow-hidden relative bg-toolbar flex flex-col transition-colors duration-300">
        <div id="loader" class="loader-bar" style="width: 0%"></div>
        <div id="viewport" class="flex-1 overflow-hidden relative bg-toolbar"></div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[110] flex items-center justify-center p-4">
        <div class="bg-dropdown rounded-lg shadow-2xl w-full max-w-[450px] p-8 relative flex flex-col border border-borderLight">
            <button onclick="window.closeAuthModal()" class="absolute top-4 right-4 p-2 text-secondary hover:bg-hover rounded-full transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div class="boogle-logo-small mb-4">
                <span style="color: var(--boogle-1)">B</span><span style="color: var(--boogle-2)">o</span><span style="color: var(--boogle-3)">o</span><span style="color: var(--boogle-4)">g</span><span style="color: var(--boogle-5)">l</span><span style="color: var(--boogle-6)">e</span>
            </div>
            <h2 id="auth-title" class="text-[24px] font-normal text-center text-primary mb-2">Create account</h2>
            <p id="auth-subtitle" class="text-center text-primary mb-8">to continue to Boogle Browser</p>

            <form id="auth-form" class="flex flex-col" onsubmit="window.submitAuth(event)">
                <div class="relative mb-6">
                    <div class="domain-input-wrapper flex items-center border border-borderLight rounded p-2 focus-within:border-blue-400">
                        <input type="text" id="auth-username" class="flex-1 outline-none bg-transparent" placeholder="Username" required />
                        <span class="text-secondary text-sm ml-1">@booglebrowser.org</span>
                    </div>
                </div>
                <div class="material-input">
                    <input type="password" id="auth-password" placeholder=" " required />
                    <label for="auth-password">Password</label>
                </div>
                <div id="auth-error" class="hidden text-red-600 text-sm mb-4"></div>
                <div class="flex justify-between items-center mt-6">
                    <button type="button" onclick="window.toggleAuthMode()" id="auth-toggle-btn" class="text-blue-600 text-sm hover:underline">Already have an account?</button>
                    <button type="submit" id="auth-submit-btn" class="bg-blue-600 text-white px-6 py-2 rounded font-medium">Next</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Account Dropdown -->
    <div id="account-dropdown" class="hidden absolute top-[50px] right-2 bg-dropdown rounded-3xl shadow-xl border border-borderLight z-[100] w-[320px] p-4 flex flex-col items-center">
        <div id="dropdown-initial-large" class="w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center text-3xl font-bold mb-3"></div>
        <div id="dropdown-email" class="text-sm text-secondary mb-6"></div>
        <button onclick="window.signOutBoogle()" class="w-full py-2 border border-borderLight rounded-full text-sm font-medium hover:bg-hover">Sign out</button>
    </div>

    <!-- Settings Dropdown -->
    <div id="settings-dropdown" class="hidden absolute top-[50px] right-[60px] bg-dropdown rounded-xl shadow-xl border border-borderLight z-[100] w-[240px] py-2 flex flex-col">
        <div onclick="window.navigateTo('boogle://history')" class="px-4 py-2.5 text-sm text-primary hover:bg-hover cursor-pointer flex items-center gap-3">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> History
        </div>
        <div onclick="window.openCustomize()" class="px-4 py-2.5 text-sm text-primary hover:bg-hover cursor-pointer flex items-center gap-3">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg> Customize
        </div>
    </div>

    <!-- Customize Sidebar -->
    <div id="customize-sidebar" class="fixed right-0 top-[88px] bottom-0 w-[320px] bg-dropdown border-l border-borderLight transform translate-x-full transition-transform z-[90] flex flex-col shadow-2xl">
        <div class="p-4 border-b border-borderLight flex justify-between items-center">
            <h2 class="text-base font-medium text-primary">Customize Boogle</h2>
            <button onclick="window.closeCustomize()" class="p-2 text-secondary hover:bg-hover rounded-full transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="p-5 overflow-y-auto">
            <div class="mb-8">
                <h3 class="text-sm font-medium text-primary mb-3">Appearance</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="window.setDarkMode(false)" class="border border-borderLight rounded-xl p-4 flex flex-col items-center gap-2 hover:bg-hover">
                        <div class="w-10 h-10 rounded-full bg-white border border-gray-200"></div>
                        <span class="text-sm font-medium">Light</span>
                    </button>
                    <button onclick="window.setDarkMode(true)" class="border border-borderLight rounded-xl p-4 flex flex-col items-center gap-2 hover:bg-hover">
                        <div class="w-10 h-10 rounded-full bg-gray-900"></div>
                        <span class="text-sm font-medium">Dark</span>
                    </button>
                </div>
            </div>
            <div class="mb-8">
                <h3 class="text-sm font-medium text-primary mb-4">Color Themes</h3>
                <div class="grid grid-cols-5 gap-3">
                    <button onclick="window.setThemeColor(null)" class="w-10 h-10 rounded-full border border-gray-300 hover:scale-110 transition-transform bg-[#dee1e6]" title="Default"></button>
                    <button onclick="window.setThemeColor('#4285F4')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#4285F4]" title="Blue"></button>
                    <button onclick="window.setThemeColor('#EA4335')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#EA4335]" title="Red"></button>
                    <button onclick="window.setThemeColor('#FBBC05')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#FBBC05]" title="Yellow"></button>
                    <button onclick="window.setThemeColor('#34A853')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#34A853]" title="Green"></button>
                    
                    <button onclick="window.setThemeColor('#6366f1')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#6366f1]" title="Indigo"></button>
                    <button onclick="window.setThemeColor('#a855f7')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#a855f7]" title="Purple"></button>
                    <button onclick="window.setThemeColor('#ec4899')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#ec4899]" title="Pink"></button>
                    <button onclick="window.setThemeColor('#f97316')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#f97316]" title="Orange"></button>
                    <button onclick="window.setThemeColor('#14b8a6')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#14b8a6]" title="Teal"></button>
                    
                    <button onclick="window.setThemeColor('#8b5cf6')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#8b5cf6]" title="Violet"></button>
                    <button onclick="window.setThemeColor('#ef4444')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#ef4444]" title="Bright Red"></button>
                    <button onclick="window.setThemeColor('#06b6d4')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#06b6d4]" title="Cyan"></button>
                    <button onclick="window.setThemeColor('#84cc16')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#84cc16]" title="Lime"></button>
                    <button onclick="window.setThemeColor('#334155')" class="w-10 h-10 rounded-full hover:scale-110 transition-transform bg-[#334155]" title="Slate"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-[#323232] text-white px-6 py-3 rounded-md shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none z-[200] text-sm">
        <span id="toast-message"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Safe config check
        let firebaseConfig = {};
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        } catch (e) {
            console.warn("Firebase config not available or invalid.");
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'boogle-browser-v1';
        
        let db, auth, canvasUser;
        let currentBoogleAccount = null;
        let isSignUpMode = true;
        let tabs = [{ id: 'initial', title: 'New Tab', type: 'new', url: '', displayUrl: '' }];
        let activeTabId = 'initial';
        let historyEntries = [];

        const startApp = async () => {
            // Immediately render basic UI to avoid "broken" look if Firebase fails
            renderAuthUI();
            renderTabs();
            renderViewport();

            if (!firebaseConfig.apiKey) {
                console.log("No API key found, running in offline mode.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    canvasUser = user;
                    if (user && db) {
                        try {
                            const sessionSnap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'boogle_session'));
                            if (sessionSnap.exists() && sessionSnap.data().activeEmail) {
                                currentBoogleAccount = { email: sessionSnap.data().activeEmail };
                                
                                const histSnap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'history'));
                                if(histSnap.exists()) historyEntries = histSnap.data().entries || [];

                                const themeSnap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'appearance'));
                                if (themeSnap.exists()) {
                                    const data = themeSnap.data();
                                    if (data.isDark) document.documentElement.classList.add('dark');
                                    if (data.customColor) document.documentElement.style.setProperty('--custom-color', data.customColor);
                                }
                                // Re-render with loaded account data
                                renderAuthUI();
                                renderTabs();
                                renderViewport();
                            }
                        } catch (e) { console.error("Data load error:", e); }
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        };

        // Start the app logic
        startApp();

        window.submitAuth = async function(e) {
            e.preventDefault();
            const username = document.getElementById('auth-username').value.trim().toLowerCase();
            const email = `${username}@booglebrowser.org`;
            const password = document.getElementById('auth-password').value;
            if (!canvasUser || !db) return;
            
            const accountRef = doc(db, 'artifacts', appId, 'users', canvasUser.uid, 'accounts', email);
            try {
                if (isSignUpMode) {
                    await setDoc(accountRef, { email, password, createdAt: Date.now() });
                } else {
                    const snap = await getDoc(accountRef);
                    if (!snap.exists() || snap.data().password !== password) {
                        const err = document.getElementById('auth-error');
                        err.innerText = "Invalid credentials";
                        err.classList.remove('hidden');
                        return;
                    }
                }
                await setDoc(doc(db, 'artifacts', appId, 'users', canvasUser.uid, 'settings', 'boogle_session'), { activeEmail: email });
                currentBoogleAccount = { email };
                await syncToCloud();
                renderAuthUI();
                window.closeAuthModal();
                showToast(isSignUpMode ? "Account created!" : "Signed in");
            } catch (err) { console.error(err); }
        };

        async function syncToCloud() {
            if (!currentBoogleAccount || !canvasUser || !db) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', canvasUser.uid, 'data', 'history'), {
                    entries: historyEntries.slice(0, 50)
                });
                const isDark = document.documentElement.classList.contains('dark');
                const customColor = document.documentElement.style.getPropertyValue('--custom-color');
                await setDoc(doc(db, 'artifacts', appId, 'users', canvasUser.uid, 'settings', 'appearance'), { isDark, customColor }, { merge: true });
            } catch (e) {}
        }

        window.toggleAuthMode = () => {
            isSignUpMode = !isSignUpMode;
            document.getElementById('auth-title').innerText = isSignUpMode ? "Create account" : "Sign in";
            document.getElementById('auth-submit-btn').innerText = isSignUpMode ? "Next" : "Sign in";
            document.getElementById('auth-toggle-btn').innerText = isSignUpMode ? "Already have an account?" : "Create account";
        };

        window.signOutBoogle = async () => {
            if (canvasUser && db) await setDoc(doc(db, 'artifacts', appId, 'users', canvasUser.uid, 'settings', 'boogle_session'), { activeEmail: null });
            currentBoogleAccount = null;
            historyEntries = [];
            document.documentElement.classList.remove('dark');
            document.documentElement.style.removeProperty('--custom-color');
            renderAuthUI();
            renderTabs();
            renderViewport();
            document.getElementById('account-dropdown').classList.add('hidden');
            showToast("Signed out.");
        };

        window.openAuthModal = () => document.getElementById('auth-modal').classList.remove('hidden');
        window.closeAuthModal = () => {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('auth-error').classList.add('hidden');
        };

        function renderAuthUI() {
            const container = document.getElementById('auth-ui');
            if (!container) return;
            if (currentBoogleAccount) {
                const initial = currentBoogleAccount.email[0].toUpperCase();
                container.innerHTML = `<button onclick="window.toggleAccountDropdown(event)" class="w-8 h-8 bg-blue-600 text-white rounded-full font-bold shadow-sm flex items-center justify-center hover:opacity-90 transition-opacity">${initial}</button>`;
                const largeInitial = document.getElementById('dropdown-initial-large');
                const emailDisplay = document.getElementById('dropdown-email');
                if (largeInitial) largeInitial.innerText = initial;
                if (emailDisplay) emailDisplay.innerText = currentBoogleAccount.email;
            } else {
                container.innerHTML = `<button onclick="window.openAuthModal()" class="bg-blue-500 text-white px-5 py-1.5 rounded font-medium text-sm hover:bg-blue-600 transition-colors">Sign in</button>`;
            }
        }

        window.toggleAccountDropdown = (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('account-dropdown');
            dropdown.classList.toggle('hidden');
            document.getElementById('settings-dropdown').classList.add('hidden');
        };

        window.toggleSettingsDropdown = (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('settings-dropdown');
            dropdown.classList.toggle('hidden');
            document.getElementById('account-dropdown').classList.add('hidden');
        };

        window.onclick = () => {
            const accDrop = document.getElementById('account-dropdown');
            const setDrop = document.getElementById('settings-dropdown');
            if (accDrop) accDrop.classList.add('hidden');
            if (setDrop) setDrop.classList.add('hidden');
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            if (!t) return;
            document.getElementById('toast-message').innerText = msg;
t.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 3000);
        }

        window.openCustomize = () => {
            const sidebar = document.getElementById('customize-sidebar');
            if (sidebar) sidebar.classList.remove('translate-x-full');
        };
        window.closeCustomize = () => {
            const sidebar = document.getElementById('customize-sidebar');
            if (sidebar) sidebar.classList.add('translate-x-full');
        };

        window.setDarkMode = async (isDark) => {
            if (isDark) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
            if (currentBoogleAccount && canvasUser && db) {
                await setDoc(doc(db, 'artifacts', appId, 'users', canvasUser.uid, 'settings', 'appearance'), { isDark }, { merge: true });
            }
        };

        window.setThemeColor = async (color) => {
            if (color) document.documentElement.style.setProperty('--custom-color', color);
            else document.documentElement.style.removeProperty('--custom-color');
            if (currentBoogleAccount && canvasUser && db) {
                await setDoc(doc(db, 'artifacts', appId, 'users', canvasUser.uid, 'settings', 'appearance'), { customColor: color }, { merge: true });
            }
        };

        function renderTabs() {
            const tabList = document.getElementById('tab-list');
            if (!tabList) return;
            tabList.innerHTML = '';
            tabs.forEach(tab => {
                const el = document.createElement('div');
                el.className = `tab-item flex items-center gap-2 px-3 h-[32px] text-[12px] min-w-[120px] max-w-[200px] rounded-t-lg cursor-pointer transition-all shrink-0 ${tab.id === activeTabId ? 'tab-active' : 'text-secondary hover:bg-hover'}`;
                el.innerHTML = `
                    <div class="truncate flex-1">${tab.title || 'New Tab'}</div>
                    <button class="close-btn opacity-0 group-hover:opacity-100 hover:bg-black/10 rounded px-1 transition-all">Ã—</button>
                `;
                el.classList.add('group');
                el.onclick = () => window.switchTab(tab.id);
                el.querySelector('.close-btn').onclick = (e) => { e.stopPropagation(); window.closeTab(tab.id); };
                tabList.appendChild(el);
            });
        }

        window.switchTab = (id) => { activeTabId = id; renderTabs(); renderViewport(); };
        
        window.closeTab = (id) => {
            if (tabs.length > 1) {
                const idx = tabs.findIndex(t => t.id === id);
                tabs = tabs.filter(t => t.id !== id);
                if (activeTabId === id) activeTabId = tabs[idx]?.id || tabs[idx - 1].id;
            } else {
                tabs = [{ id: 'initial', title: 'New Tab', type: 'new', url: '', displayUrl: '' }];
                activeTabId = 'initial';
            }
            renderTabs(); renderViewport();
        };

        const addTabBtn = document.getElementById('add-tab');
        if (addTabBtn) {
            addTabBtn.onclick = () => {
                const id = Math.random().toString(36).substr(2, 9);
                tabs.push({ id, title: 'New Tab', type: 'new', url: '', displayUrl: '' });
                window.switchTab(id);
            };
        }

        window.handleAddressSubmit = (e) => {
            e.preventDefault();
            const input = document.getElementById('address-input');
            if (input) window.navigateTo(input.value);
        };

        window.navigateTo = async (input) => {
            const tab = tabs.find(t => t.id === activeTabId);
            let url = input.trim();
            if (!url) return;

            if (url === 'boogle://history') {
                tab.type = 'history';
                tab.title = 'History';
                tab.displayUrl = url;
            } else {
                if (!url.includes('.') || url.includes(' ')) {
                    url = `https://www.google.com/search?q=${encodeURIComponent(url)}&igu=1`;
                } else if (!/^https?:\/\//i.test(url)) {
                    url = 'https://' + url;
                }

                const entry = { title: url, url: url, timestamp: Date.now() };
                historyEntries.unshift(entry);
                if (currentBoogleAccount && canvasUser && db) {
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'users', canvasUser.uid, 'data', 'history'), { entries: historyEntries.slice(0, 50) });
                    } catch (e) {}
                }

                tab.type = 'web';
                tab.url = url;
                tab.displayUrl = url;
                tab.title = url.replace(/^https?:\/\/(www\.)?/, '').split('/')[0];
            }
            renderTabs();
            renderViewport();
        };

        window.refreshActiveTab = () => {
            const tab = tabs.find(t => t.id === activeTabId);
            if (tab.type === 'web') renderViewport(true);
        };

        window.handleFeelingLucky = () => {
            const searchInput = document.getElementById('home-search');
            const query = searchInput ? searchInput.value : '';
            if (query) {
                window.navigateTo(query);
            } else {
                const randomSites = [
                    'https://en.wikipedia.org/wiki/Special:Random',
                    'https://apod.nasa.gov/apod/astropix.html',
                    'https://www.nationalgeographic.com',
                    'https://www.howstuffworks.com'
                ];
                const site = randomSites[Math.floor(Math.random() * randomSites.length)];
                window.navigateTo(site);
            }
        };

        function renderViewport(forceReload = false) {
            const container = document.getElementById('viewport');
            const addressInput = document.getElementById('address-input');
            if (!container || !addressInput) return;

            const tab = tabs.find(t => t.id === activeTabId);
            addressInput.value = tab.displayUrl || '';

            if (tab.type === 'new') {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full animate-in fade-in duration-500">
                        <div class="flex flex-col items-center">
                            <div class="boogle-logo-container">
                                <span style="color: var(--boogle-1)">B</span><span style="color: var(--boogle-2)">o</span><span style="color: var(--boogle-3)">o</span><span style="color: var(--boogle-4)">g</span><span style="color: var(--boogle-5)">l</span><span style="color: var(--boogle-6)">e</span>
                            </div>
                        </div>
                        <div class="w-full max-w-[584px] px-4 mt-8">
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-4 flex items-center text-secondary">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                </div>
                                <input id="home-search" onkeydown="if(event.key==='Enter') window.navigateTo(this.value)" class="w-full pl-12 pr-4 py-3 bg-toolbar border border-borderLight rounded-full shadow-sm hover:shadow-md focus:shadow-md outline-none transition-shadow text-primary" placeholder="Search or type a URL" />
                            </div>
                            <div class="flex justify-center gap-3 mt-8">
                                <button onclick="window.navigateTo(document.getElementById('home-search').value)" class="px-5 py-2 bg-inputBox rounded text-sm text-secondary hover:border-borderLight border border-transparent transition-colors">Boogle Search</button>
                                <button onclick="window.handleFeelingLucky()" class="px-5 py-2 bg-inputBox rounded text-sm text-secondary hover:border-borderLight border border-transparent transition-colors">I'm Feeling Lucky</button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tab.type === 'history') {
                container.innerHTML = `
                    <div class="p-8 h-full overflow-y-auto bg-toolbar">
                        <h1 class="text-2xl font-medium mb-6">History</h1>
                        <div class="max-w-3xl mx-auto flex flex-col gap-2">
                            ${historyEntries.length ? historyEntries.map(e => `
                                <div class="flex items-center gap-4 p-3 hover:bg-hover rounded-lg cursor-pointer" onclick="window.navigateTo('${e.url}')">
                                    <span class="text-xs text-secondary w-16">${new Date(e.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                    <span class="text-sm flex-1 truncate font-medium">${e.title}</span>
                                    <span class="text-xs text-secondary truncate max-w-[200px]">${e.url}</span>
                                </div>
                            `).join('') : '<div class="text-center text-secondary py-12">No history yet</div>'}
                        </div>
                    </div>
                `;
            } else if (tab.type === 'web') {
                const loader = document.getElementById('loader');
                if (loader) loader.style.width = '30%';
                
                const existingIframe = container.querySelector('iframe');
                if (!forceReload && existingIframe && existingIframe.getAttribute('src') === tab.url) {
                    if (loader) {
                        loader.style.width = '100%';
                        setTimeout(() => loader.style.width = '0%', 300);
                    }
                    return;
                }
                container.innerHTML = `<iframe src="${tab.url}" sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-modals allow-presentation"></iframe>`;
                const iframe = container.querySelector('iframe');
                iframe.onload = () => {
                    if (loader) {
                        loader.style.width = '100%';
                        setTimeout(() => loader.style.width = '0%', 300);
                    }
                };
            }
        }
    </script>
</body>
</html>
